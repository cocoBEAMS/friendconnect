<!DOCTYPE html>
<html lang="en">
<head>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    .friends-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;

      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(6px);

      z-index: 5000;
    }

    .friends-content {
      position: relative;
      width: 90%;
      max-width: 420px;

      background: rgba(20, 20, 30, 0.9);
      color: white;

      border-radius: 18px;
      padding: 24px;

      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
    }

    .friends-content h2 {
      margin: 0 0 16px;
      font-size: 20px;
    }

    .friends-close {
      position: absolute;
      top: 14px;
      right: 16px;
      font-size: 22px;
      cursor: pointer;
      opacity: 0.7;
    }

    .friends-close:hover {
      opacity: 1;
    }

    .friends-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;

      background: linear-gradient(135deg, #6d6dff, #9b7bff);
      color: white;

      border: none;
      border-radius: 999px;
      padding: 14px 22px;

      font-size: 15px;
      font-weight: 600;
      cursor: pointer;

      box-shadow: 0 12px 30px rgba(109, 109, 255, 0.35);
      transition: transform 0.2s ease, box-shadow 0.2s ease;

      z-index: 1000;
    }

    .friends-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 40px rgba(109, 109, 255, 0.45);
    }

    .friends-btn:active {
      transform: scale(0.96);
    }

    /* Overlay */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    /* Card */
    .modal-card {
      background: #0a0d14;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 28px;
      width: 100%;
      max-width: 420px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    /* Icon */
    .modal-icon {
      font-size: 42px;
      color: var(--accent);
      margin-bottom: 12px;
    }

    /* Title */
    .modal-card h2 {
      margin: 0 0 10px;
      font-size: 22px;
    }

    /* Text */
    .modal-card p {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.6;
      margin-bottom: 22px;
    }

    /* Button */
    .primary-btn {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: none;
      background: var(--accent);
      color: #0777f7;
      font-weight: 600;
      cursor: pointer;
    }

    .primary-btn:hover {
      opacity: 0.9;
    }


    #requestsList {
      margin-bottom: 32px;
    }

    #requestsList span {
      display: block;
      padding: 16px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      text-align: center;
    }

    .request-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .request-card span {
      font-size: 14px;
    }

    .request-actions button {
      margin-left: 8px;
      padding: 6px 10px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }

    .accept-btn {
      background: var(--blue);
      color: white;
    }

    .decline-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .add-friend {
      margin-top: 12px;
      width: 100%;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid var(--blue);
      background: transparent;
      color: var(--blue);
      font-weight: 600;
      cursor: pointer;
    }

    .add-friend:hover {
      background: rgba(59,130,246,0.1);
    }

    html {
      min-height: 100%;
      background: var(--bg);
    }

    .premium-banner {
      max-width: 1100px;
      margin: 20px auto 0;
      padding: 14px 20px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: #0d1220;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .premium-banner strong {
      display: block;
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
    }

    .premium-banner span {
      font-size: 13px;
      color: var(--muted);
    }

    .premium-banner button {
      padding: 8px 14px;
      border-radius: 10px;
      border: 1px solid var(--red);
      background: transparent;
      color: var(--red);
      font-weight: 600;
      cursor: pointer;
    }
  </style>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FriendConnect</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0d14;
      --panel: #0f1420;
      --border: #1e2638;
      --text: #e9ecf1;
      --muted: #8b93a7;
      --blue: #3b82f6;
      --red: #ef4444;
      --radius: 14px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, sans-serif;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--blue);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .profile .bio {
      font-size: 13px;
      color: var(--muted);
      display: -webkit-box;
      -webkit-line-clamp: 2; /* üëà change to 2 if you want */
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .profile .bio.expanded {
      -webkit-line-clamp: unset;
    }

    .read-more {
      font-size: 12px;
      color: var(--blue);
      cursor: pointer;
      margin-top: 6px;
      display: inline-block;
    }

    /* NAVBAR */
    nav {
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      border-bottom: 1px solid var(--border);
      background: #0a0d14;
    }

    .logo {
      font-weight: 800;
      letter-spacing: -0.02em;
      font-size: 20px;
    }

    .nav-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .nav-link {
      font-size: 14px;
      color: var(--muted);
      cursor: pointer;
    }

    .nav-btn {
      padding: 8px 14px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      border: 1px solid var(--blue);
      background: transparent;
      color: var(--blue);
      cursor: pointer;
    }

    /* PROFILES GRID */
    .container {
      max-width: 1100px;
      margin: 32px auto 80px;
      padding: 0 20px;
    }

    .profiles {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 16px;
    }

    .profile {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      transition: border-color .2s ease;
    }

    .profile:hover {
      border-color: var(--blue);
    }

    .profile h3 {
      margin: 0 0 6px;
      font-size: 16px;
      font-weight: 600;
    }

    .profile span {
      font-size: 13px;
      color: var(--muted);
      display: block;
    }

    .tags {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    /* MODAL */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      width: 420px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 24px;
    }

    .badge {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      background: rgba(239,68,68,0.15);
      color: var(--red);
      margin-bottom: 12px;
    }

    .modal h2 {
      margin: 0 0 8px;
      font-size: 20px;
    }

    .modal p {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 16px;
    }

    .deal-box {
      border: 1px solid var(--blue);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 16px;
      font-weight: 600;
      color: var(--blue);
    }

    .modal button {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      border: none;
      background: var(--blue);
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <nav>
    <div class="logo">FriendConnect</div>
    <div class="nav-actions">
      <div class="nav-link" id="userNav" onclick="openAuthIfNeeded()">Sign in</div>
      <button class="nav-btn" id="openDeal">Best Friend Deal</button>
    </div>
  </nav>

  <!-- AUTH MODAL -->
  <div class="overlay" id="authModal">
    <div class="modal">
     

      <div class="badge">FriendConnect</div>
      <h2 id="authTitle">Make an account</h2>
      <p>Create your FriendConnect profile. Your Profile is stored securely in the cloud. Avoid making your password anything important.</p>
      <input id="email" placeholder="Email"
        style="width:100%;margin-bottom:8px;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0a0d14;color:var(--text);" />

      <input id="password" type="password" placeholder="Password"
        style="width:100%;margin-bottom:12px;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0a0d14;color:var(--text);" />
      <input id="name" placeholder="Name" style="width:100%;margin-bottom:8px;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0a0d14;color:var(--text);" />
      <input id="age" placeholder="Age" type="number" style="width:100%;margin-bottom:8px;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0a0d14;color:var(--text);" />
      <input
        id="bio"
        placeholder="Short bio"
        style="width:100%;margin-bottom:12px;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0a0d14;color:var(--text);"
      />

     
      <div id="bioCounter" style="font-size:12px;color:var(--muted);text-align:right;margin-bottom:12px;">
        0 / 150
      </div>

      <button onclick="saveProfile()">Create account</button>
    </div>
  </div>

  <div class="premium-banner">
    <div>
      <strong>FriendConnect Premium</strong>
      <span>Priority matches, unlimited requests, verified badge</span>
    </div>
    <button onclick="openDealFromBanner()">Upgrade</button>
  </div>
  
  <div class="container">
    <h2 style="margin-bottom:12px;">
      Friend Requests
    </h2>

    <div id="requestsList"></div>
  </div>


  <div class="container">
    <div class="profiles" id="profilesGrid">
    
        </div>

  <div class="overlay" id="dealModal">
    <div class="modal">
      <div class="badge">Limited Offer</div>
      <h2>Best Friend Deal</h2>
      <p>Get priority matching, unlimited requests, and verified badges.</p>
      <div class="deal-box">Free for early members</div>
      <button onclick="closeDeal()">Claim deal</button>
    </div>
  </div>
  
    <script type="module">
      
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        onAuthStateChanged
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        collection,
        getDocs
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      import {
        query,
        where,
        deleteDoc
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCvCAnjI58ns5dWgmcY_saq1w3W_Qe9I7Y",
        authDomain: "friendconnect-99a50.firebaseapp.com",
        projectId: "friendconnect-99a50",
        storageBucket: "friendconnect-99a50.appspot.com",
        messagingSenderId: "904196830848",
        appId: "1:904196830848:web:50c15121c2c04f1ea01865"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      let sentRequests = new Set();

      /* ‚úÖ NOW everything exists */
      async function loadIncomingRequests(user) {
        const requestsList = document.getElementById("requestsList");
        requestsList.innerHTML = "";

        const q = query(
          collection(db, "friendRequests"),
          where("to", "==", user.uid),
          where("status", "==", "pending")
        );

        const snap = await getDocs(q);

        if (snap.empty) {
          requestsList.innerHTML = `<span style="color:var(--muted)">No requests yet</span>`;
          return;
        }

        for (const docSnap of snap.docs) {
          const req = docSnap.data();

          const senderSnap = await getDoc(doc(db, "users", req.from));
          if (!senderSnap.exists()) continue;

          const sender = senderSnap.data();

          const card = document.createElement("div");
          card.className = "request-card";

          card.innerHTML = `
            <span><strong>${sender.name}</strong> wants to be your friend</span>
            <div class="request-actions">
              <button class="accept-btn" onclick="acceptRequest('${docSnap.id}', '${req.from}')">Accept</button>
              <button class="decline-btn" onclick="declineRequest('${docSnap.id}')">Decline</button>
            </div>
          `;

          requestsList.appendChild(card);
        }
      }
      async function loadSentRequests(user) {
        sentRequests.clear();

        const q = query(
          collection(db, "friendRequests"),
          where("from", "==", user.uid),
          where("status", "==", "pending")
        );

        const snap = await getDocs(q);

        snap.forEach((docSnap) => {
          const req = docSnap.data();
          sentRequests.add(req.to);
        });
      }


      const authModal = document.getElementById("authModal");
      const betaSeen = localStorage.getItem("betaSeen");
      if (!betaSeen) {
        document.getElementById("betaModal").style.display = "flex";
      }

      const userNav = document.getElementById("userNav");
      const profilesGrid = document.getElementById("profilesGrid");
      const bioInput = document.getElementById("bio");
      const bioCounter = document.getElementById("bioCounter");

      bioInput.addEventListener("input", () => {
        const length = bioInput.value.length;
        bioCounter.textContent = `${length} / 150`;

        // Optional visual warning
        bioCounter.style.color = length > 150 ? "var(--red)" : "var(--muted)";
      });

      authModal.addEventListener("click", (e) => { if (e.target === authModal) authModal.style.display = "none"; });
      function renderProfile(profile, isYou = false) {
        if (!profile?.name) return;

        const bioText = profile.bio || "";
        const isLongBio = bioText.length > 90;

        const card = document.createElement("div");
        card.className = "profile";

        card.innerHTML = `
          <div class="avatar">${profile.name[0].toUpperCase()}</div>

          <h3>${profile.name}, ${profile.age ?? "?"}</h3>

          <span class="bio">${bioText || "No bio yet"}</span>

          ${isLongBio ? `<span class="read-more">Read more</span>` : ""}

          <div class="tags">
            <div class="tag">${isYou ? "You" : "Member"}</div>
          </div>

       ${!isYou
         ? sentRequests.has(profile.uid)
           ? `<button class="add-friend sent" disabled>Request Sent</button>`
           : `<button class="add-friend" onclick="sendFriendRequest('${profile.uid}')">Add Friend</button>`
         : ""
       }


        `;

        profilesGrid.appendChild(card);
      }


      // Open auth modal
      window.openAuthIfNeeded = () => {
        authModal.style.display = "flex";
      };
      window.closeBetaModal = () => {
        localStorage.setItem("betaSeen", "true");
        document.getElementById("betaModal").style.display = "none";
      };

      // Open deal modal
      window.openDealFromBanner = () => {
        document.getElementById("dealModal").style.display = "flex";
      };

      // Close deal modal
      window.closeDeal = () => {
        document.getElementById("dealModal").style.display = "none";
      };


      // Create account OR sign in
      window.saveProfile = async () => {
        const name = document.getElementById("name").value.trim();
        const age = Number(document.getElementById("age").value);
        const bio = document.getElementById("bio").value.trim();
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;

        // 1Ô∏è‚É£ Auth fields first
        if (!email || !password) {
          alert("Email and password required");
          return;
        }

        // 2Ô∏è‚É£ Empty profile fields
        if (!name || !age || !bio) {
          alert("Please fill out all profile fields");
          return;
        }

        // 3Ô∏è‚É£ Age check
        if (!Number.isInteger(age) || age < 13 || age > 120) {
          alert("Age must be a number between 13 and 120");
          return;
        }

        // 4Ô∏è‚É£ Bio length limit
        if (bio.length > 150) {
          alert("Bio must be 150 characters or less");
          return;
        }

        try {
          let cred;

          // Try creating account
          try {
            cred = await createUserWithEmailAndPassword(auth, email, password);
          } catch (err) {
            // If account already exists ‚Üí sign in instead
            if (err.code === "auth/email-already-in-use") {
              cred = await signInWithEmailAndPassword(auth, email, password);
            } else {
              throw err;
            }
          }

          // Only create Firestore profile if it doesn't exist
          const userRef = doc(db, "users", cred.user.uid);
          const snap = await getDoc(userRef);

          if (!snap.exists()) {
            await setDoc(userRef, {
              name,
              age,
              bio,
              createdAt: Date.now()
            });
          }

          authModal.style.display = "none";
        } catch (err) {
          alert(err.message);
        }
      };

      // Auth state listener
      if (!localStorage.getItem("betaSeen")) {
        document.getElementById("betaModal").style.display = "flex";
      }

      onAuthStateChanged(auth, async (user) => {
        if (!user) return;
        profilesGrid.innerHTML = "";
        authModal.style.display = "none";

        await loadSentRequests(user);
        loadIncomingRequests(user);
        loadFriends();
        // Get YOUR profile
        const yourSnap = await getDoc(doc(db, "users", user.uid));
        if (!yourSnap.exists()) return;

        const yourProfile = yourSnap.data();
        userNav.textContent = yourProfile.name;

        
       

        // Render YOU first
        renderProfile(yourProfile, true);

        // Load ALL other users
        const allUsersSnap = await getDocs(collection(db, "users"));

        allUsersSnap.forEach((docSnap) => {
          if (docSnap.id === user.uid) return;

          const profile = docSnap.data();
          renderProfile({ ...profile, uid: docSnap.id }, false);
        });

      });
      window.sendFriendRequest = async (targetUid) => {
        const user = auth.currentUser;
        if (!user) return alert("You must be logged in");

        const requestId = `${user.uid}_${targetUid}`;

        try {
          await setDoc(doc(db, "friendRequests", requestId), {
            from: user.uid,
            to: targetUid,
            status: "pending",
            createdAt: Date.now()
          });

          alert("Friend request sent!");
        } catch (err) {
          alert("Error sending request");
          console.error(err);
        }
      };
      window.acceptRequest = async (requestId, fromUid) => {
        const user = auth.currentUser;
        if (!user) return;

        try {
          // Create friendship
          await setDoc(doc(db, "friends", `${user.uid}_${fromUid}`), {
            users: [user.uid, fromUid],
            createdAt: Date.now()
          });

          // Remove request
          await deleteDoc(doc(db, "friendRequests", requestId));
          sentRequests.delete(fromUid);

          // Refresh UI
          loadIncomingRequests(user);
        } catch (err) {
          console.error(err);
          alert("Failed to accept request");
        }
      };
      window.declineRequest = async (requestId) => {
        const user = auth.currentUser;
        if (!user) return;

        try {
          await deleteDoc(doc(db, "friendRequests", requestId));
          loadIncomingRequests(user);
        } catch (err) {
          console.error(err);
          alert("Failed to decline request");
        }
      };
     

    </script>
     
    <div id="betaModal" class="modal-overlay">
      <div class="modal-card">
        <span class="material-icons modal-icon">science</span>

        <h2>FriendConnect is in Beta</h2>

        <p>
          You're early! This project is still under active development.
          Some features may change or break.
        </p>

        <button class="primary-btn" onclick="closeBetaModal()">
          Got it
        </button>
      </div>
    </div>
    <button id="friendsBtn" class="friends-btn">
      Friends
    </button>
    <div id="friendsModal" class="friends-modal">
      <div class="friends-content">
        <span class="friends-close" onclick="closeFriends()">√ó</span>
        <h2>Your Friends</h2>
        <div id="friendsList">
          <span style="color:var(--muted)">No friends yet</span>
        </div>
      </div>
    </div>
    <script>
      const friendsBtn = document.getElementById("friendsBtn");

      friendsBtn.addEventListener("click", () => {
        openFriends();
      });

      window.openFriends = async () => {
        document.getElementById("friendsModal").style.display = "flex";
        await loadFriends();
      };


      window.closeFriends = () => {
        document.getElementById("friendsModal").style.display = "none";
      };
      async function loadFriends() {
        const user = auth.currentUser;
        if (!user) return;

        const friendsList = document.getElementById("friendsList");
        friendsList.innerHTML = "";

        const q = query(
          collection(db, "friends"),
          where("users", "array-contains", user.uid)
        );

        const snap = await getDocs(q);

        if (snap.empty) {
          friendsList.innerHTML = `<span style="color:var(--muted)">No friends yet</span>`;
          return;
        }

        for (const docSnap of snap.docs) {
          const data = docSnap.data();
          const friendUid = data.users.find(uid => uid !== user.uid);

          const friendSnap = await getDoc(doc(db, "users", friendUid));
          if (!friendSnap.exists()) continue;

          const friend = friendSnap.data();

          const div = document.createElement("div");
          div.style.padding = "10px 0";
          div.style.borderBottom = "1px solid var(--border)";
          div.innerHTML = `<strong>${friend.name}</strong>`;

          friendsList.appendChild(div);
        }
      }

    </script>

</body>
</html>
